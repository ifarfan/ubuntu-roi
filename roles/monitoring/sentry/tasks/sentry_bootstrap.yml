---
- name: Run Post-installation MySQL Upgrade
  shell: |
    source bin/activate
    export SENTRY_CONF=/etc/sentry.conf.py
    sentry upgrade --noinput
    sentry createuser
    sentry repair --owner={{ sentry_admin_user }}
    chdir=/opt/sentry
    executable=/bin/bash

# # Bootstrap Sentry Install
# - name: Check if django superuser exists
#   shell: "mysql -e \"SELECT uuu.username FROM sentry.auth_user AS uuu WHERE uuu.username='{{ sentry_admin_user }}';\""
#   ignore_errors: yes
#   register: superuser
#   tags: bootstrap

# - name: Copy bootstrap files
#   template:
#     src={{ files_dir }}/opt/sentry/bootstrap.py.j2
#     dest=/opt/sentry/bootstrap.py
#     owner=root
#     group=root
#     mode=0755
#   when: superuser.stdout.find('{{ sentry_admin_user }}') == -1
#   tags: bootstrap

# - name: Call Bootstrap script
#   shell: source bin/activate && export SENTRY_CONF=/etc/sentry.conf.py && python bootstrap.py chdir=/opt/sentry/ executable=/bin/bash
#   ignore_errors: yes
#   when: superuser.stdout.find('{{ sentry_admin_user }}') == -1
#   tags:
#      - bootstrap
#      - sentry

# - name: Remove bootstrap file
#   file:
#     path=/opt/sentry/bootstrap.py
#     state=absent
#   when: superuser.stdout.find('{{ sentry_admin_user }}') == -1
#   tags: bootstrap

# - name: Run sentry repair command on database
#   shell: "/opt/sentry/bin/sentry --config=/etc/sentry.conf.py repair --owner={{ sentry_admin_user }}"
#   when: superuser.stdout.find('{{ sentry_admin_user }}') == -1
#   ignore_errors: yes
#   tags: bootstrap

# - name: Set default site
#   shell: "mysql -e \"UPDATE sentry.django_site SET domain='refinery29.com', name='refinery29.com' WHERE id=1;\""
#   ignore_errors: yes
#   tags: bootstrap


# # Fix bug where /account/settings/notifications/ raises an error due to missing info for Sentry's internal project
# # More info here: https://github.com/getsentry/sentry/issues/960
# - name: Update owner and team for internal Sentry project
#   shell: "mysql -e \"UPDATE sentry.sentry_project SET owner_id=1, team_id=1 WHERE id=1;\""
#   ignore_errors: yes
#   register: superuser
